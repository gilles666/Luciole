<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Détecteur Dalmatien</title>
  <style>
    body {
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      margin:0; display:flex; flex-direction:column; align-items:center;
      gap:10px; padding:12px; background:#111; color:#fff;
      min-height:100vh; box-sizing:border-box;
    }
    video { width:100%; max-width:640px; border-radius:12px; background:#000; }
    canvas { display:none; }
    button {
      padding:10px 14px; border-radius:8px; border:none;
      background:#0a84ff; color:white; font-weight:600;
    }
    .row { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    #status { font-size:0.95rem; opacity:0.9; }
    #label { font-size:1.05rem; font-weight:700; margin-top:6px; }
  </style>
</head>
<body>
  <h1>Détecteur Merlinou</h1>
  <video id="video" autoplay playsinline></video>
  <canvas id="snap" width="224" height="224"></canvas>

  <!-- Boutons principaux -->
  <div class="row">
    <button id="startBtn">Démarrer</button>
    <button id="stopBtn" disabled>Arrêter</button>
  </div>

  <!-- Boutons manuels pour la porte -->
  <div class="row">
    <button id="openBtn" style="background:#34c759;">🔓 Ouvrir porte</button>
    <button id="closeBtn" style="background:#ff3b30;">🔒 Fermer porte</button>
  </div>

  <div id="status">Statut: attente</div>
  <div id="label"></div>

  <!-- TensorFlow.js + MobileNet -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>

  <script>
    const video = document.getElementById('video');
    const snap = document.getElementById('snap');
    const ctx = snap.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const openBtn = document.getElementById('openBtn');
    const closeBtn = document.getElementById('closeBtn');
    const statusEl = document.getElementById('status');
    const labelEl = document.getElementById('label');

    // --- CONFIG ---
    const URL_OUVRIR = 'https://maison.deschamps.ch/ouvrir';
    const URL_FERMER = 'https://maison.deschamps.ch/fermer';
    const CHECK_INTERVAL_MS = 700;
    const CONFIDENCE_THRESHOLD = 0.6;
    const COOLDOWN_MS = 10000; // 10s entre deux déclenchements automatiques
    const TEMPS_FERMETURE_MS = 10000; // 10s après ouverture

    let model = null;
    let stream = null;
    let running = false;
    let lastSentAt = 0;
    let audioCtx;

    function setStatus(t){ statusEl.textContent = 'Statut: ' + t; }

    async function startCamera(){
      stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:'environment'}, audio:false });
      video.srcObject = stream;
      await video.play();
    }

    async function loadModel(){
      setStatus('Chargement modèle MobileNet...');
      await tf.ready();
      model = await mobilenet.load({ version: 2, alpha: 1.0 });
      setStatus('Modèle chargé ✅');
    }

    function beep(){
      try{
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.type = 'sine';
        osc.frequency.value = 880; // Hz
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.2);
      }catch(e){ console.error('Erreur bip:', e); }
    }
    // --- Nouvelle fonction : ouverture puis fermeture automatique ---
    function ouvrirPuisFermer(){
      setStatus('Dalmatien détecté 🐶 → ouverture !');
      beep();
      sendGet(URL_OUVRIR);
      setTimeout(()=>{
        setStatus('Fermeture automatique...');
        sendGet(URL_FERMER);
      }, TEMPS_FERMETURE_MS);
    }
    async function analyzeLoop(){
      if(!running) return;
      try{
        ctx.drawImage(video,0,0,snap.width,snap.height);
        const results = await model.classify(snap);
        if(results && results.length){
          const top = results[0];
          labelEl.textContent = `${top.className} — ${(top.probability*100).toFixed(1)}%`;
          const name = top.className.toLowerCase();
          const isDalmatian = name.includes('dalmatian') || name.includes('dalmatien');
          if(isDalmatian && top.probability >= CONFIDENCE_THRESHOLD){
            const now = Date.now();
            if(now - lastSentAt > COOLDOWN_MS){
              lastSentAt = now;
              ouvrirPuisFermer();
            } else {
              setStatus('Dalmatien détecté — cooldown');
            }
          } else {
            setStatus('Analyse en cours...');
          }
        }
      }catch(e){
        console.error('Erreur analyse:', e);
        setStatus('Erreur analyse');
      }finally{
        setTimeout(analyzeLoop, CHECK_INTERVAL_MS);
      }
    }

    function sendGet(url){
      fetch(url, { method:'GET', mode:'no-cors' })
        .then(()=>console.log('GET envoyé à', url))
        .catch(err=>console.error('Erreur GET', err));
    }

    async function startAll(){
      startBtn.disabled = true;
      try{
        await startCamera();
        await loadModel();
        running = true;
        stopBtn.disabled = false;
        analyzeLoop();
      }catch(e){
        console.error(e);
        setStatus('Erreur démarrage');
        startBtn.disabled = false;
      }
    }

    function stopAll(){
      running = false;
      stopBtn.disabled = true;
      startBtn.disabled = false;
      labelEl.textContent = '';
      setStatus('Arrêté');
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
        video.srcObject = null;
      }
    }

    // --- Événements ---
    startBtn.addEventListener('click', startAll);
    stopBtn.addEventListener('click', stopAll);
    openBtn.addEventListener('click', ()=>{ setStatus('Ouverture manuelle 🚪'); beep(); sendGet(URL_OUVRIR); });
    closeBtn.addEventListener('click', ()=>{ setStatus('Fermeture manuelle 🚪'); beep(); sendGet(URL_FERMER); });
  </script>
</body>
</html>
